[{"path":"https://antiphon.github.io/ospats2/articles/legacy.html","id":"legacy-code-summary","dir":"Articles","previous_headings":"","what":"Legacy code, summary","title":"Ospats legacy code","text":"ospats2 package includes refactored legacy code Ospats R-package (now deprecated) Julia code.","code":""},{"path":"https://antiphon.github.io/ospats2/articles/legacy.html","id":"ospats-r-library","dir":"Articles","previous_headings":"Legacy code, summary","what":"Ospats R-library","title":"Ospats legacy code","text":"R-package Ospats found : https://github.com/brendo1001/ospats/ original Ospats::ospatsF included ospats2::ospatsF minor differences reduce footprint: call fastPdist2(Ar = .matrix(z), Br = .matrix(z)))^2 now outer(z, z, \"-\")^2 call fastVsum(Ar = .matrix(s2)) now outer(s2, s2, \"+\") call fastPdist2(Ar = xy, Br = xy) now .matrix(dist(xy)) rewrote (refactored) Ospats::ospatsF development purposes changes: k-means starting partition algorithm included (equals parameter dStart=0) inputs renamed ouputs simplified New option: covariance matrix can inputted -new function called ospatsF_ref, renamed parameters described : Note input refactored function tibble, data.frame similar named vectors x,y coordinates pred,var target variable predictions variances. legacy function data matrix variables order x,y,pred,var. Note covariance ospatsF computed \\(\\sigma_{ij}^2:=0.5(\\sigma_i^2+\\sigma_j^2)\\rho_{ij}\\), even though correct form \\(\\sigma_{ij}^2=\\sigma_i\\sigma_j\\rho_{ij}\\). can provided using Cov parameter.","code":"# in ospatsF: ospatsF_ref (x,                  # dat              covmodel_range,     # dRange              nstrata,            # dStrata              niter = 100,        # nCycles              niter_outer = 100,  # nMaxrun              verbose = FALSE,    # =              temperature = 1,    # initialTemperature              coolingrate = .95,  # coolingRate              rsquared = 1,       # dRSquare              Cov                 # not in ospatsF                                  # Omitted:                                  # debug, dStart, ClusterStart )"},{"path":"https://antiphon.github.io/ospats2/articles/legacy.html","id":"julia-implementation","dir":"Articles","previous_headings":"Legacy code, summary","what":"Julia implementation","title":"Ospats legacy code","text":"Julia code found : https://github.com/jjdegruijter/ospats/ rewrite Julia code file ospatsmr. functionality wrapped user-facing function, original code used global variables, see main julia file original repository. Note: implement partitioning sections code, sample allocation sampling sections output written files interface aligned original R-function: refactored code new inputs: Julia implementation differs R-implementation key parts: ospatsF: run starts k-means partition ospatsF_julia: run starts completely random allocation ospatsF: slightly worsening move small probability . probabilities go zero iteration (tempering, factor coolingrate) ospatsF_julia: tempering, just consider improvements","code":"ospatsF_julia <- (                           data,                           dRange,                           dRSquare,                           dMaxrun,                           nCycles,                           dStrata,                           verbose                          ) ospatsF_julia_ref (                           x,                           covmodel_range,                           rsquared,                           niter_outer,                           niter,                           nstrata,                           verbose,                           Cov # optional, new                         )"},{"path":"https://antiphon.github.io/ospats2/articles/legacy.html","id":"an-example","dir":"Articles","previous_headings":"Legacy code, summary","what":"An example","title":"Ospats legacy code","text":"illustrate refactoring change results. Load example data: run algorithm original R-package Ospats. duplicated , modification C-code replaced native R calls (see help details). Check equality. Pretty much . Note since Julia-based algorithm different (see details), results might differ. align.","code":"data(\"ospats_test_data1\", package = \"ospats2\") dat1 <- subset(ospats_test_data1, obs) x <- with(   dat1,   data.frame(x = x, y = y, pred = z.pred.mean, var = z.pred.var)           )  dat <- x |> as.matrix() ## Original: set.seed(1) o1 <- ospats2::ospatsF(   data = dat,   dRange = 3000,   dStart = 0,   dStrata = 3,   dRSquare = 1,   dMaxrun = 5,   nCycles = 100,   initialTemperature = 1,   coolingRate = 0.95,   verbose = FALSE  ) #> [1] \"-----OSPATS INITIALISATION------\" #> [1] \"Initial Solution\" #> [1] \"distance matrix\" #> [1] \"matrix of maximum covariance\" #> [1] \"D2 sum matrix\" #> [1] \"Objective function=  1.8003396381012\" #> [1] \"Objective function=  1.8003396381012\" #> [1] \"Objective function=  1.8003396381012\" #> [1] \"Objective function=  1.8003396381012\" #> [1] \"Objective function=  1.8003396381012\" # Refactored: set.seed(1) o2 <- ospats2::ospatsF_ref(   x  = x,   covmodel_range = 3000,   nstrata = 3,   rsquared = 1,   niter_outer = 5,   niter = 100,   temperature = 1,   coolingrate = 0.95,   verbose = FALSE  ) table(old = o1$stratFrame[,5], new= o2$stratification  )  #>    new #> old  1  2  3 #>   1 51  0  0 #>   2  0 30  0 #>   3  0  0 40 # Should be reorder-diagonal  print( c(obj_old = o1$objective, obj_new = o2$Obar )) #> obj_old obj_new  #> 1.80034 1.80034 # Simpler julia-code algorithm set.seed(1) j1 <- ospats2::ospatsF_julia_ref(   x = x,   covmodel_range = 3000,   nstrata = 3,   niter_outer = 5,   niter = 100 )  print(table(R=o2$stratification, J=j1$stratification)) #>    J #> R    1  2  3 #>   1  0  0 51 #>   2 30  0  0 #>   3  0 40  0  print(c(obj_julia=j1$Obar)) #> obj_julia  #>   1.80034"},{"path":"https://antiphon.github.io/ospats2/authors.html","id":null,"dir":"","previous_headings":"","what":"Authors","title":"Authors and Citation","text":"Tuomas Rajala. Maintainer.","code":""},{"path":"https://antiphon.github.io/ospats2/authors.html","id":"citation","dir":"","previous_headings":"","what":"Citation","title":"Authors and Citation","text":"Rajala T (2023). ospats2: Optimal Startification Correlations. https://antiphon.github.io/ospats2/, https://github.com/antiphon/ospats2/.","code":"@Manual{,   title = {ospats2: Optimal Startification With Correlations},   author = {Tuomas Rajala},   year = {2023},   note = {https://antiphon.github.io/ospats2/, https://github.com/antiphon/ospats2/}, }"},{"path":[]},{"path":"https://antiphon.github.io/ospats2/index.html","id":"what","dir":"","previous_headings":"","what":"What","title":"Optimal Startification With Correlations ","text":"R-package ospats2 (unofficial) re-boot/re-imagining optimal spatial stratification sample allocation package Ospats, implementing eponymous algorithm describe De Gruijter, Minasny, Mcbratney (2015)1, written Brendan Malone Nicolas Saby. original package CRAN (ever ), closest thing official R-package can tell can found https://github.com/brendo1001/ospats/. Last relevant update repository dates back 2016, package date 2016-07-19. another repository authors containing Julia code 2017 De Gruijter others. Code can found https://github.com/jjdegruijter/ospats. code written Julia versions 1.0 much deprecated (Updated code repo comparisons).","code":""},{"path":"https://antiphon.github.io/ospats2/index.html","id":"why","dir":"","previous_headings":"","what":"Why","title":"Optimal Startification With Correlations ","text":"method described De Gruijter, Minasny, Mcbratney potential uses work (Luke, Finland), original package longer developed. like use develope method . example, like freedom inputting spatial correlation structure, able work spatio-temporal populations.","code":""},{"path":"https://antiphon.github.io/ospats2/index.html","id":"plan","dir":"","previous_headings":"","what":"Plan","title":"Optimal Startification With Correlations ","text":"original Ospats::ospatsF refactored included comparison purposes (ospatsF_ref) Julia version translated R (ospatsF_julia; Just stratification parts) New user-facing function constructed, superseeding input flexibility original ospatsF Cross-compatibility packages, inputs outputs. Optimize code Design principle close /compatible spsurvey package (seems alive 2022-10-05). implements Generalized Random Tesselation Stratification (GRTS) algorithm similar job Ospats, also loads functions post-stratification tasks sampling estimation.","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospats2-package.html","id":null,"dir":"Reference","previous_headings":"","what":"ospats2: Optimal Startification With Correlations — ospats2-package","title":"ospats2: Optimal Startification With Correlations — ospats2-package","text":"Reboot Ospats (2017). Compute optimal stratification (spatial) population accounting unit--unit correlations.","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospats2-package.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"ospats2: Optimal Startification With Correlations — ospats2-package","text":"Reboot Ospats.","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospats2-package.html","id":"what","dir":"Reference","previous_headings":"","what":"What","title":"ospats2: Optimal Startification With Correlations — ospats2-package","text":"R-package ospats2 reboot optimal spatial stratification sample allocation package Ospats, implementing eponymous algorithm describe De Gruijter, Minasny, Mcbratney (2015), written Brendan Malone Nicolas Saby. original package CRAN (ever ), closest thing official R-package can tell can found https://github.com/brendo1001/ospats/. Last relevant update repository dates back 2016, package date 2016-07-19. another repository authors containing Julia code 2017 De Gruijter others. Code can found https://github.com/jjdegruijter/ospats. code written Julia versions 1.0 much deprecated (Updated code repo comparisons).","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospats2-package.html","id":"why","dir":"Reference","previous_headings":"","what":"Why","title":"ospats2: Optimal Startification With Correlations — ospats2-package","text":"method described De Gruijter, Minasny, Mcbratney potential uses work (Luke, Finland), original package longer developed. like use develope method . example, like freedom inputting spatial correlation structure, able work spatio-temporal populations. See vignettes details.","code":""},{"path":[]},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF.html","id":null,"dir":"Reference","previous_headings":"","what":"Ospats Function from Ospats-package — ospatsF","title":"Ospats Function from Ospats-package — ospatsF","text":"Copy-paste original code (small edits)","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Ospats Function from Ospats-package — ospatsF","text":"","code":"ospatsF(   data = NULL,   dRange = NULL,   nCycles = NULL,   dStart = NULL,   ClusterStart = NULL,   dMaxrun = NULL,   dRSquare = NULL,   dStrata = NULL,   initialTemperature = NULL,   coolingRate = NULL,   debug = FALSE,   verbose = TRUE )"},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Ospats Function from Ospats-package — ospatsF","text":"data data matrix columns x y pred var specific order dRange Range parameter exponential correlation model nCycles Number iterations per one run optimisation algorithm dStart choose kMeans (0) CumrootSquare(1) external (3) ClusterStart external dStart == 3 (Saby Input) dMaxrun Number independent (apart initial states) repeated optimisation runs dRSquare R^2 parameter adjusting \"regression---mean\" (see paper) dStrata Number strata initialTemperature simulated annealing parameter coolingRate simulated annealing parameter debug Useful development troubleshooting issues verbose Print runtime diagnostics","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Ospats Function from Ospats-package — ospatsF","text":"refactoring changes original code minimize footprint: call fastPdist2(Ar = .matrix(z), Br = .matrix(z)))^2 now  outer(z, z, \"-\")^2 call fastVsum(Ar = .matrix(s2)) now outer(s2, s2, \"+\") call fastPdist2(Ar = xy, Br = xy) now .matrix(dist(xy)) code touched. documentation added.","code":""},{"path":[]},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF.html","id":"opstats-algorithm-","dir":"Reference","previous_headings":"","what":"opstats algorithm:","title":"Ospats Function from Ospats-package — ospatsF","text":"described de Gruijter et al. (2015) Optimizing Stratification Allocation Design-Based Estimation Spatial Means Using Predictions Error","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF.html","id":"what-does-it-do-","dir":"Reference","previous_headings":"","what":"What does it do:","title":"Ospats Function from Ospats-package — ospatsF","text":"Given map (instance digital soil map) prediction variance function derive spatial stratifcation somewhere spectrum including compact geographical stratification (high uncertainty) clusters based quantiles data (low uncertainty).","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF_julia.html","id":null,"dir":"Reference","previous_headings":"","what":"Ospats Julia Version in R — ospatsF_julia","title":"Ospats Julia Version in R — ospatsF_julia","text":"Translate Julia version Ospats R","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF_julia.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Ospats Julia Version in R — ospatsF_julia","text":"","code":"ospatsF_julia(   data,   dRange,   dRSquare,   dMaxrun,   nCycles,   dStrata,   verbose = FALSE )"},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF_julia.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Ospats Julia Version in R — ospatsF_julia","text":"data data matrix columns x y pred var specific order dRange Range parameter exponential correlation model dRSquare R^2 parameter adjusting \"regression---mean\" (see paper) dMaxrun Number independent (apart initial states) repeated optimisation runs nCycles Number iterations per one run optimisation algorithm dStrata Number strata verbose Print runtime diagnostics","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF_julia.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Ospats Julia Version in R — ospatsF_julia","text":"original Julia code: https://github.com/jjdegruijter/ospats/ , file \"ospatsmr\" original code uses global variables; version mimics input naming original ospatsF. code computes stratification, Neyman allocation sampling \"Section 6\" Julia code, code include \"Section 7.\" writes results file.","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF_julia_ref.html","id":null,"dir":"Reference","previous_headings":"","what":"Ospats Julia Version in R — ospatsF_julia_ref","title":"Ospats Julia Version in R — ospatsF_julia_ref","text":"Refactor Julia version Ospats R","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF_julia_ref.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Ospats Julia Version in R — ospatsF_julia_ref","text":"","code":"ospatsF_julia_ref(   x,   nstrata = 3,   niter_outer = 3,   niter = 100,   verbose = FALSE,   rsquared = 1,   covmodel_range,   Cov )"},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF_julia_ref.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Ospats Julia Version in R — ospatsF_julia_ref","text":"x data, variables x y pred var nstrata number starta consider niter_outer Number independent runs optimisation algorithm niter Number iterations per one run optimisation algorithm verbose Print runtime diagnostics? rsquared R^2 paper (default: 1) covmodel_range Range parameter assumed exponential correlation model Cov Optional, overrides covariance matrix calculation using exp-correlation. checks data variances.","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF_julia_ref.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Ospats Julia Version in R — ospatsF_julia_ref","text":"original Julia code: https://github.com/jjdegruijter/ospats/ , file \"ospatsmr\" original code uses global variables; version mimics input naming original ospatsF. code computes stratification, Neyman allocation sampling \"Section 6\" Julia code, code include \"Section 7.\" writes results file. \"_ref\" refactored version, similar ospatsF_ref, notably input names change.","code":""},{"path":[]},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF_ref.html","id":null,"dir":"Reference","previous_headings":"","what":"Legacy Ospats Algorithm — ospatsF_ref","title":"Legacy Ospats Algorithm — ospatsF_ref","text":"Refactored Ospats::ospatsF","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF_ref.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Legacy Ospats Algorithm — ospatsF_ref","text":"","code":"ospatsF_ref(   x,   covmodel_range,   nstrata,   niter = 100,   niter_outer = 100,   verbose = FALSE,   temperature = 1,   coolingrate = 0.95,   rsquared = 1,   Cov )"},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF_ref.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Legacy Ospats Algorithm — ospatsF_ref","text":"x data, variables x y pred var covmodel_range Range parameter assumed exponential correlation model nstrata number starta consider niter Number iterations per one run optimisation algorithm niter_outer Number independent runs optimisation algorithm verbose Print runtime diagnostics? temperature Annealing factor, accept slightly bad moves prob ~exp(-abs(delta)/temperature) coolingrate Change temperature interation factor. 1. rsquared R^2 paper (default: 1) Cov Optional, overrides covariance matrix calculation using exp-correlation. checks data variances.","code":""},{"path":"https://antiphon.github.io/ospats2/reference/ospatsF_ref.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Legacy Ospats Algorithm — ospatsF_ref","text":"algorithm ospatsF new inputs outputs. change covariance matrix can given avoid exponential covariance assumption \"mean\" covariance formula used original scripts. See vignette vignette(\"legacy\",)","code":""}]
